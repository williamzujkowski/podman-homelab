#!/bin/bash
# {{ ansible_managed }}
# APT updates textfile collector for Node Exporter

apt list --upgradable 2>/dev/null | grep -v "Listing..." | wc -l | awk '{print "node_apt_upgrades_pending " $1}'

# Security updates
apt list --upgradable 2>/dev/null | grep -c security | awk '{print "node_apt_security_upgrades_pending " $1}'

# Last update check time
if [ -f /var/lib/apt/periodic/update-success-stamp ]; then
    echo -n "node_apt_last_update_timestamp "
    stat -c %Y /var/lib/apt/periodic/update-success-stamp
else
    echo "node_apt_last_update_timestamp 0"
fi

# Repository status
apt-cache policy | grep -c "release " | awk '{print "node_apt_repositories_total " $1}'