---
- name: Configure Grafana OAuth2 with Authentik
  hosts: pi-a  # Monitoring node where Grafana runs
  become: yes
  vars:
    # Use IP addresses for initial setup, HTTPS domains for production
    authentik_url: "http://192.168.1.13:9002"
    authentik_https_url: "https://auth.homelab.grenlan.com"
    grafana_url: "http://192.168.1.12:3000"
    grafana_https_url: "https://grafana.homelab.grenlan.com"

  tasks:
    - name: Check if Grafana is running in container
      ansible.builtin.stat:
        path: /etc/grafana/grafana.ini
      register: grafana_config_file

    - name: Update Grafana configuration for OAuth2 (native install)
      ansible.builtin.blockinfile:
        path: /etc/grafana/grafana.ini
        block: |
          [auth]
          disable_login_form = false
          oauth_auto_login = false

          [auth.generic_oauth]
          enabled = true
          name = Authentik
          icon = signin
          client_id = {{ vault_grafana_oauth_client_id | default('grafana') }}
          client_secret = {{ vault_grafana_oauth_client_secret | default('') }}
          scopes = openid profile email groups
          auth_url = {{ authentik_url }}/application/o/authorize/
          token_url = {{ authentik_url }}/application/o/token/
          api_url = {{ authentik_url }}/application/o/userinfo/
          allowed_domains = 
          allow_assign_grafana_admin = true
          auto_assign_org = true
          auto_assign_org_id = 1
          auto_assign_org_role = Viewer
          allow_sign_up = true
          role_attribute_path = |
            contains(groups, 'Grafana Admins') && 'Admin' ||
            contains(groups, 'Grafana Editors') && 'Editor' ||
            'Viewer'
          email_attribute_path = email
          name_attribute_path = name
          login_attribute_path = preferred_username
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Authentik OAuth2"
        create: no
        backup: yes
      when: grafana_config_file.stat.exists
      notify: restart grafana

    - name: Update Grafana configuration for OAuth2 (container)
      ansible.builtin.copy:
        content: |
          [auth]
          disable_login_form = false
          oauth_auto_login = false

          [auth.generic_oauth]
          enabled = true
          name = Authentik
          icon = signin
          client_id = {{ vault_grafana_oauth_client_id | default('grafana') }}
          client_secret = {{ vault_grafana_oauth_client_secret | default('') }}
          scopes = openid profile email groups
          auth_url = {{ authentik_url }}/application/o/authorize/
          token_url = {{ authentik_url }}/application/o/token/
          api_url = {{ authentik_url }}/application/o/userinfo/
          allowed_domains = 
          allow_assign_grafana_admin = true
          auto_assign_org = true
          auto_assign_org_id = 1
          auto_assign_org_role = Viewer
          allow_sign_up = true
          role_attribute_path = |
            contains(groups[*].name, 'Grafana Admins') && 'Admin' ||
            contains(groups[*].name, 'Grafana Editors') && 'Editor' ||
            'Viewer'
          email_attribute_path = email
          name_attribute_path = name
          login_attribute_path = preferred_username
        dest: /tmp/grafana-oauth.ini
        mode: '0644'
      when: not grafana_config_file.stat.exists
      notify: restart grafana container

    - name: Create instructions for Authentik configuration
      ansible.builtin.copy:
        content: |
          # Authentik Configuration for Grafana OAuth2

          1. Log into Authentik at {{ authentik_url }}
          2. Navigate to Applications > Providers
          3. Create a new OAuth2/OpenID Provider:
             - Name: Grafana
             - Authorization flow: default-provider-authorization-explicit-consent
             - Client type: Confidential
             - Client ID: grafana
             - Client Secret: (generate and save to vault as vault_grafana_oauth_client_secret)
             - Redirect URIs: {{ grafana_url }}/login/generic_oauth
             - Signing Key: authentik Self-signed Certificate

          4. Create an Application:
             - Name: Grafana
             - Slug: grafana
             - Provider: Grafana (the provider you just created)
             - Launch URL: {{ grafana_url }}

          5. Create Groups:
             - Grafana Admins
             - Grafana Editors
             - Grafana Viewers

          6. Assign users to appropriate groups

          7. Update the vault with:
             - vault_grafana_oauth_client_id (if different from 'grafana')
             - vault_grafana_oauth_client_secret (from step 3)

          8. Re-run this playbook after updating vault
        dest: /etc/grafana/authentik-setup-instructions.txt
        owner: root
        group: grafana
        mode: '0640'

    - name: Display setup instructions
      ansible.builtin.debug:
        msg:
          - "IMPORTANT: Manual configuration required in Authentik!"
          - "See /etc/grafana/authentik-setup-instructions.txt for details"
          - ""
          - "After configuring Authentik:"
          - "1. Update vault with OAuth2 credentials"
          - "2. Re-run this playbook"
          - "3. Restart Grafana"

  handlers:
    - name: restart grafana
      ansible.builtin.systemd:
        name: grafana-server
        state: restarted

    - name: restart grafana container
      ansible.builtin.command:
        cmd: podman restart systemd-grafana
      become: yes
      ignore_errors: yes
