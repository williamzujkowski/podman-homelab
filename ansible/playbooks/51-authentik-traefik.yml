---
- name: Configure Traefik with Authentik ForwardAuth Integration
  hosts: pi-b  # Ingress node where Traefik is running
  become: yes
  vars:
    authentik_host: "192.168.1.13"
    authentik_port: "9002"  # Updated to avoid MinIO conflict
    authentik_url: "http://{{ authentik_host }}:{{ authentik_port }}"
    authentik_external_url: "https://auth.homelab.grenlan.com"

  tasks:
    - name: Create Traefik dynamic configuration for Authentik
      ansible.builtin.copy:
        content: |
          http:
            routers:
              authentik:
                rule: "Host(`auth.homelab.grenlan.com`)"
                service: authentik
                tls:
                  certResolver: letsencrypt
                middlewares:
                  - default-headers
                  - https-redirect

              # Outpost router for forward auth
              authentik-outpost:
                rule: "Host(`auth.homelab.grenlan.com`) && PathPrefix(`/outpost.goauthentik.io/`)"
                service: authentik
                tls:
                  certResolver: letsencrypt
                priority: 100

            services:
              authentik:
                loadBalancer:
                  servers:
                    - url: "{{ authentik_url }}"
                  healthCheck:
                    path: /api/v3/root/config/
                    interval: 30s
                    timeout: 3s

            middlewares:
              # ForwardAuth middleware for protected services
              authentik-auth:
                forwardAuth:
                  address: "{{ authentik_url }}/outpost.goauthentik.io/auth/traefik"
                  trustForwardHeader: true
                  authResponseHeaders:
                    - X-authentik-username
                    - X-authentik-groups
                    - X-authentik-email
                    - X-authentik-name
                    - X-authentik-uid
                    - X-authentik-jwt
                    - X-authentik-meta-jwks
                    - X-authentik-meta-outpost
                    - X-authentik-meta-provider
                    - X-authentik-meta-app
                    - X-authentik-meta-version

              default-headers:
                headers:
                  stsSeconds: 31536000
                  stsIncludeSubdomains: true
                  stsPreload: true
                  forceSTSHeader: true
                  contentTypeNosniff: true
                  browserXssFilter: true
                  referrerPolicy: "strict-origin-when-cross-origin"
                  customFrameOptionsValue: "SAMEORIGIN"

              https-redirect:
                redirectScheme:
                  scheme: https
                  permanent: true
        dest: /etc/traefik/dynamic/authentik.yml
        owner: root
        group: root
        mode: '0644'
      notify: restart traefik

    - name: Verify Authentik is accessible from current host
      ansible.builtin.uri:
        url: "{{ authentik_url }}/api/v3/root/config/"
        method: GET
        timeout: 10
        status_code: 200
      register: authentik_connectivity_test
      ignore_errors: yes

    - name: Display connectivity test results
      ansible.builtin.debug:
        msg:
          - "Authentik connectivity test: {{ 'PASSED' if authentik_connectivity_test.status == 200 else 'FAILED' }}"
          - "Status code: {{ authentik_connectivity_test.status | default('N/A') }}"
          - "Note: ForwardAuth will work if Traefik can reach Authentik, even if this test fails"

  handlers:
    - name: restart traefik
      ansible.builtin.shell: |
        podman restart systemd-traefik
      become: yes

  post_tasks:
    - name: Display configuration deployment results
      ansible.builtin.debug:
        msg:
          - "==== Authentik-Traefik Integration Deployment Results ===="
          - "Authentik External URL: {{ authentik_external_url }}"
          - "Authentik Internal URL: {{ authentik_url }}"
          - "Traefik Dashboard: http://{{ inventory_hostname }}:8080"
          - ""
          - "ForwardAuth Middleware: authentik-auth"
          - "Auth Endpoint: {{ authentik_url }}/outpost.goauthentik.io/auth/traefik"
          - ""
          - "Configuration deployed to: /etc/traefik/dynamic/authentik.yml"
          - ""
          - "To protect a service, add middleware to its router:"
          - "  middlewares:"
          - "    - authentik-auth"
